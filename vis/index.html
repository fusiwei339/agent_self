<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<!-- <script src="https://d3js.org/d3.v5.js"></script> -->

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>

<script type="module">
    function dataprocessing(data){
        let ret=[]
        data.forEach((element, group) => {
            let val=Object.values(element).sort((a, b)=>b-a)
            val.forEach((e, i)=>{
                ret.push({group, rank:""+i, val:e})
            })
        });
        return ret
    }

    function drawPixelBar(svg, data, h, w, drawYaxis){
        var margin = {top: 0, right: 0, bottom: 0, left: 0},
            width = w- margin.left - margin.right,
            height = h- margin.top - margin.bottom;

        const series = d3.stack()
            .keys(d3.union(data.map(d => d.rank))) // distinct series keys, in input order
            .value(([, D], key) => D.get(key).val) // get value for each series key and stack
            (d3.index(data, d => d.group, d => d.rank)); // group by stack then series key

        // Prepare the scales for positional and color encodings.
        const x = d3.scaleBand()
            .domain(d3.groupSort(data, (g1, g2) => {
                let g1sum=d3.sum(g1, d => d.val)
                let g2sum=d3.sum(g2, d => d.val)
                if(g1sum == g2sum){
                    console.log(g1, g2)
                    for(let i=g1.length-1;i>0; i--){
                        if(g1[i].val==g2[i].val) continue
                        return g1[i].val-g2[i].val
                    }
                }
                return g1sum-g2sum
            }, d => d.group))
            .range([margin.left, width - margin.right])
            .padding(0);

        const y = d3.scaleLinear()
            .domain([0, 140])
            .rangeRound([height - margin.bottom, margin.top]);

        const color = d3.scaleSequential(d3.interpolateBlues)
            .domain([0, 40])
            .unknown("#ccc");

        svg.append("g")
            .selectAll()
            .data(series)
            .join("g")
            .selectAll("rect")
            .data(D => D.map(d => (d.key = D.key, d)))
            .join("rect")
            .attr("x", d => x(d.data[0]))
            .attr("y", d => y(d[1]))
            .attr("height", d => y(d[0]) - y(d[1]))
            .attr("width", x.bandwidth())
            .attr("fill", d => color(d[1]-d[0]))
            .append("title")

        // Append the vertical axis.
        if(drawYaxis){
            svg.append("g")
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y).ticks(null, "s"))
                .call(g => g.selectAll(".domain").remove());
        }
    }

    // import { csv, json } from 'd3-fetch'
    import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";
    Promise.all([
        d3.json("json/gpt-4o_neutral_percent_self_0.7_None.csv.json"),
        d3.json("json/gpt-4o_neutral_percent_self_0.7_poem_None.csv.json"),
        d3.json("json/gpt-4o_neutral_percent_group_0.7_None.csv.json"),
        d3.json("json/gpt-4o_neutral_percent_self_0.0_None.csv.json"),
        d3.json("json/gpt-4o_neutral_percent_self_1.4_None.csv.json"),
        d3.json("json/gpt-4-1106-preview_neutral_percent_self_0.7_None.csv.json"),
        d3.json("json/gpt-3.5-turbo-0125_neutral_percent_self_0.7_None.csv.json"),
        d3.json("json/gpt-4o_neutral_percent_self_0.7_an_American.csv.json"),
        d3.json("json/gpt-4o_neutral_percent_self_0.7_an_Asian_American.csv.json"),
        d3.json("json/gpt-4o_neutral_percent_self_0.7_an_African_American.csv.json"),
        d3.json("json/gpt-4o_negative_percent_self_0.7_None.csv.json"),
        d3.json("json/gpt-4o_positive_percent_self_0.7_None.csv.json"),
    ])
    .then((data) =>  {
        // data=dataprocessing(data);

        var margin = {top: 10, right: 10, bottom: 40, left: 30},
            width = 1570 - margin.left - margin.right,
            height = 1300 - margin.top - margin.bottom;
        // append the svg object to the body of the page
        var svg = d3.select("#my_dataviz")
            .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
            .selectAll("g")
            .data(data).enter()
            .append("g")
                .attr("transform", (d, i)=>
                    "translate(" + (margin.left+i*100) + "," + margin.top + ")")
                .each(function(d, i){
                    let node=d3.select(this)
                    let b=i==0?true:false
                    let input=dataprocessing(d)
                    drawPixelBar(node, input, 270, 80, b)
                })
    });


</script>